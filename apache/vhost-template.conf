#
# Copyright (c) 2025-2025 Ricardo do Canto
#
# This file is part of the EnduranceTrio Tracker project.
#
# Licensed under the Functional Software License (FSL), Version 1.1, ALv2 Future License
# (the "License");
#
# You may not use this file except in compliance with the License. You may obtain a copy
# of the License at https://fsl.software/
#
# THE SOFTWARE IS PROVIDED "AS IS" AND WITHOUT WARRANTIES OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING WITHOUT LIMITATION WARRANTIES OF FITNESS FOR A PARTICULAR
# PURPOSE, MERCHANTABILITY, TITLE OR NON-INFRINGEMENT.
#
# IN NO EVENT WILL WE HAVE ANY LIABILITY TO YOU ARISING OUT OF OR RELATED TO THE
# SOFTWARE, INCLUDING INDIRECT, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES,
# EVEN IF WE HAVE BEEN INFORMED OF THEIR POSSIBILITY IN ADVANCE.
#

#
# Apache Virtual Host Configuration Template
# ==========================================
#
# This file serves as a template for the configuration of the Apache server as a reverse proxy
# for the EnduranceTrio Tracker application. It handles both main domain access
# and API endpoints with proper redirects and headers.
#
# REPLACEMENT GUIDE:
# ------------------
# Replace ALL placeholder tags <PLACEHOLDER> with your actual values:
#
# DOMAIN CONFIGURATION:
#   <SECOND_LEVEL_DOMAIN_SLD>  - Your domain name (e.g., 'example' in example.com)
#   <TOP_LEVEL_DOMAIN_TLD>    - Your top-level domain (e.g., 'com', 'org', 'net')
#
# SERVER ADMIN:
#   <SERVER_ADMIN_EMAIL>      - Administrator email for server notifications
#
# APPLICATION PORT:
#   <TRACKER_EXT_PORT>        - External port where your tracker app runs (e.g., 8080, 8081)
#
# REQUIRED APACHE MODULES:
# ------------------------
# sudo a2enmod proxy
# sudo a2enmod proxy_http
# sudo a2enmod headers
# sudo systemctl restart apache2
#

# --------------------------------------------------------------------------------------------------
# WWW to non-WWW redirects
# --------------------------------------------------------------------------------------------------

<VirtualHost *:80>
    ServerName www.<SECOND_LEVEL_DOMAIN_SLD>.<TOP_LEVEL_DOMAIN_TLD>
    Redirect permanent / http://<SECOND_LEVEL_DOMAIN_SLD>.<TOP_LEVEL_DOMAIN_TLD>/
</VirtualHost>

# --------------------------------------------------------------------------------------------------
# Reverse Proxy Configuration
# --------------------------------------------------------------------------------------------------

# Main domain
<VirtualHost *:80>
    ServerName <SECOND_LEVEL_DOMAIN_SLD>.<TOP_LEVEL_DOMAIN_TLD>

    ServerAdmin <SERVER_ADMIN_EMAIL>

    ProxyPreserveHost On

    # Forwarding configuration
    ProxyPass / http://localhost:<TRACKER_EXT_PORT>/
    ProxyPassReverse / http://localhost:<TRACKER_EXT_PORT>/

    # Headers configuration
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"

    ErrorLog ${APACHE_LOG_DIR}/<SECOND_LEVEL_DOMAIN_SLD>_error.log
    CustomLog ${APACHE_LOG_DIR}/<SECOND_LEVEL_DOMAIN_SLD>_access.log combined
</VirtualHost>

# API Subdomain
<VirtualHost *:80>
    ServerName api.<SECOND_LEVEL_DOMAIN_SLD>.<TOP_LEVEL_DOMAIN_TLD>

    ServerAdmin <SERVER_ADMIN_EMAIL>

    ProxyPreserveHost On

    # Forwarding configuration
    ProxyPass / http://localhost:<TRACKER_EXT_PORT>/api/
    ProxyPassReverse / http://localhost:<TRACKER_EXT_PORT>/api/

    # Headers configuration
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"

    ErrorLog ${APACHE_LOG_DIR}/api_<SECOND_LEVEL_DOMAIN_SLD>_error.log
    CustomLog ${APACHE_LOG_DIR}/api_<SECOND_LEVEL_DOMAIN_SLD>_access.log combined
</VirtualHost>

# OpenAPI Subdomain
<VirtualHost *:80>
    ServerName openapi.<SECOND_LEVEL_DOMAIN_SLD>.<TOP_LEVEL_DOMAIN_TLD>

    ServerAdmin <SERVER_ADMIN_EMAIL>

    ProxyPreserveHost On

    # Rewrite configuration
    RewriteEngine On
    RewriteRule ^/$ /swagger-ui/index.html [R=302,L]

    # Forwarding configuration
    ProxyPass / http://localhost:<TRACKER_EXT_PORT>/
    ProxyPassReverse / http://localhost:<TRACKER_EXT_PORT>/

    # Headers configuration
    RequestHeader set X-Forwarded-Proto "http"
    RequestHeader set X-Forwarded-Port "80"

    ErrorLog ${APACHE_LOG_DIR}/openapi_<SECOND_LEVEL_DOMAIN_SLD>_error.log
    CustomLog ${APACHE_LOG_DIR}/openapi_<SECOND_LEVEL_DOMAIN_SLD>_access.log combined
</VirtualHost>
